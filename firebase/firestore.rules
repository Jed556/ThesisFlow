rules_version = '2';

service cloud.firestore {
    match /databases/{database}/documents {

        // ====================================
        // HELPER FUNCTIONS
        // ====================================

        /**
         * Check if user is authenticated
         */
        function isAuthenticated() {
            return request.auth != null;
        }

        /**
         * Get user role from custom claims (set during authentication)
         * This is more efficient than reading from Firestore on every request
         */
        function getUserRole() {
            return request.auth.token.role;
        }

        /**
         * Check if user has specific role via custom claims
         */
        function hasRole(role) {
            return isAuthenticated() && getUserRole() == role;
        }

        /**
         * Check if user has any of the specified roles
         */
        function hasAnyRole(roles) {
            return isAuthenticated() && getUserRole() in roles;
        }

        /**
         * Check if user is admin
         */
        function isAdmin() {
            return hasRole('admin');
        }

        /**
         * Check if user is developer (for initial setup)
         */
        function isDeveloper() {
            return hasRole('developer');
        }

        /**
         * Check if user is admin or developer
         */
        function isAdminOrDeveloper() {
            return isAdmin() || isDeveloper();
        }

        /**
         * Check if user is head
         */
        function isHead() {
            return hasRole('head');
        }

        /**
         * Check if user is adviser
         */
        function isAdviser() {
            return hasRole('adviser');
        }

        /**
         * Check if user is editor
         */
        function isEditor() {
            return hasRole('editor');
        }

        /**
         * Check if user is moderator
         */
        function isModerator() {
            return hasRole('moderator');
        }

        /**
         * Check if user is statistician
         */
        function isStatistician() {
            return hasRole('statistician');
        }

        /**
         * Check if user is panel member
         */
        function isPanelMember() {
            return hasRole('panel');
        }

        /**
         * Check if user is student
         */
        function isStudent() {
            return hasRole('student');
        }

        /**
         * Check if user is staff (any role with elevated privileges)
         */
        function isStaff() {
            return hasAnyRole(['admin', 'developer', 'head', 'adviser', 'editor', 'moderator', 'statistician', 'panel']);
        }

        /**
         * Check if user is expert (adviser, editor, or statistician)
         */
        function isExpert() {
            return hasAnyRole(['adviser', 'editor', 'statistician']);
        }

        /**
         * Check if user is moderator or above (moderator, head, admin)
         */
        function isModeratorOrAbove() {
            return hasAnyRole(['moderator', 'head', 'admin', 'developer']);
        }

        /**
         * Check if user is the owner of a document
         */
        function isOwner(userId) {
            return isAuthenticated() && request.auth.uid == userId;
        }

        /**
         * Check if user belongs to a specific department (via custom claims)
         */
        function userInDepartment(department) {
            return isAuthenticated() && request.auth.token.department == department;
        }

        /**
         * Check if user belongs to a specific course (via custom claims)
         */
        function userInCourse(course) {
            return isAuthenticated() && request.auth.token.course == course;
        }

        // ====================================
        // COLLECTION GROUP RULES
        // These rules allow collection group queries across all paths
        // Admins/developers have full access for imports and management
        // ====================================

        // Collection group: users - allows querying and managing users across all hierarchical paths
        match /{path=**}/users/{userId} {
            allow read: if isAuthenticated();
            // Users can update their own profile, admins/developers can update any
            allow write: if isAdminOrDeveloper() || isOwner(userId);
        }

        // Collection group: groups - allows querying and managing groups across all paths
        match /{path=**}/groups/{groupId} {
            allow read: if isAuthenticated();
            allow write: if isAdminOrDeveloper();
        }

        // Collection group: thesis - allows querying and managing thesis across all paths
        match /{path=**}/thesis/{thesisId} {
            allow read: if isAuthenticated();
            allow write: if isAdminOrDeveloper();
        }

        // Collection group: expertRequests
        match /{path=**}/expertRequests/{requestId} {
            allow read: if isAuthenticated();
            allow write: if isAdminOrDeveloper();
        }

        // Collection group: templates (course templates for terminal requirements, chapters, etc.)
        match /{path=**}/templates/{templateId} {
            allow read: if isAuthenticated();
            allow write: if isAdminOrDeveloper();
        }

        // Collection group: entries (terminal requirement entries under templates)
        match /{path=**}/entries/{entryId} {
            allow read: if isAuthenticated();
            allow write: if isAdminOrDeveloper();
        }

        // Collection group: terminal
        // Note: More specific rules apply at the nested path level
        // This allows collection group queries for admins
        match /{path=**}/terminal/{terminalId} {
            allow read: if isAuthenticated();
            // Write operations should go through the nested path rules
            // which check group membership
            allow write: if isAuthenticated();
        }

        // Collection group: proposals
        match /{path=**}/proposals/{proposalId} {
            allow read: if isAuthenticated();
            allow write: if isAdminOrDeveloper();
        }

        // Collection group: stages
        match /{path=**}/stages/{stageId} {
            allow read: if isAuthenticated();
            allow write: if isAdminOrDeveloper();
        }

        // Collection group: chapters
        match /{path=**}/chapters/{chapterId} {
            allow read: if isAuthenticated();
            allow write: if isAdminOrDeveloper();
        }

        // Collection group: submissions
        match /{path=**}/submissions/{submissionId} {
            allow read: if isAuthenticated();
            allow write: if isAdminOrDeveloper();
        }

        // Collection group: chats
        match /{path=**}/chats/{chatId} {
            allow read: if isAuthenticated();
            allow write: if isAdminOrDeveloper();
        }

        // Collection group: audits
        match /{path=**}/audits/{auditId} {
            allow read: if isAuthenticated();
            // Audits are immutable - only admins can create, no updates/deletes
            allow create: if isAdminOrDeveloper();
        }

        // Collection group: panelComments
        match /{path=**}/panelComments/{commentId} {
            allow read: if isAuthenticated();
            allow write: if isAdminOrDeveloper();
        }

        // Collection group: join - for invite/request queries across all groups
        match /{path=**}/join/{docId} {
            allow read: if isAuthenticated();
            allow write: if isAdminOrDeveloper();
        }

        // ====================================
        // GLOBAL USERS COLLECTION (legacy/lookup)
        // ====================================

        match /users/{userId} {
            // Anyone authenticated can read user profiles for lookup
            allow read: if isAuthenticated();
            // Users can update their own profile, admins/developers can update any
            allow update: if isOwner(userId) || isAdminOrDeveloper();
            // Only admins/developers can create or delete users
            allow create, delete: if isAdminOrDeveloper();
        }

        // ====================================
        // YEAR-BASED HIERARCHICAL STRUCTURE
        // ====================================

        match /year/{year} {
            // Year documents - accessible to all authenticated users
            allow read: if isAuthenticated();
            allow write: if isAdminOrDeveloper() || isHead();

            // Year-level users (admin, developer)
            match /users/{userId} {
                allow read: if isAuthenticated();
                allow write: if isAdminOrDeveloper();
            }

            // ================================
            // INSTITUTIONAL AGENDAS
            // ================================

            match /agendas/{agendaId} {
                // All authenticated users can read agendas
                allow read: if isAuthenticated();
                // Only admins, developers, and heads can manage agendas
                allow write: if isAdminOrDeveloper() || isHead();
            }

            // ================================
            // SLOT REQUESTS
            // ================================

            match /slotRequests/{requestId} {
                // Slot requests - experts can read their own, admins can read all
                allow read: if isAuthenticated() && (
                    isAdminOrDeveloper() || 
                    resource.data.expertUid == request.auth.uid
                );
                // Experts can create their own requests
                allow create: if isAuthenticated() && 
                    isExpert() && 
                    request.resource.data.expertUid == request.auth.uid;
                // Only admins can approve/reject (update status)
                allow update: if isAdminOrDeveloper();
                // Only admins can delete
                allow delete: if isAdminOrDeveloper();
            }

            // ================================
            // DEPARTMENTS
            // ================================

            match /departments/{department} {
                // Department documents
                allow read: if isAuthenticated();
                allow write: if isAdminOrDeveloper() || isHead();

                // Department-level users (adviser, editor, statistician, panel, moderator, head)
                match /users/{userId} {
                    allow read: if isAuthenticated();
                    allow write: if isAdminOrDeveloper() || isHead() || (isOwner(userId) && userInDepartment(department));
                }

                // ================================
                // DEPARTMENTAL AGENDAS
                // ================================

                match /departmentAgendas/{agendaId} {
                    // All authenticated users can read departmental agendas
                    allow read: if isAuthenticated();
                    // Only admins, developers, and heads can manage agendas
                    allow write: if isAdminOrDeveloper() || isHead();
                }

                // ================================
                // COURSES
                // ================================

                match /courses/{course} {
                    // Course documents
                    allow read: if isAuthenticated();
                    allow write: if isAdminOrDeveloper() || isHead() || isAdviser();

                    // Course-level users (students)
                    match /users/{userId} {
                        allow read: if isAuthenticated();
                        allow write: if isAdminOrDeveloper() || isHead() || isAdviser() || isOwner(userId);
                    }

                    // ================================
                    // COURSE TEMPLATES (terminal requirements config, chapter templates, etc.)
                    // ================================

                    match /templates/{templateId} {
                        // All authenticated users can read templates (students need to see requirements)
                        allow read: if isAuthenticated();
                        // Only admins/developers can manage templates
                        allow write: if isAdminOrDeveloper();

                        // Entries subcollection (terminal requirement entries)
                        match /entries/{entryId} {
                            allow read: if isAuthenticated();
                            allow write: if isAdminOrDeveloper();
                        }
                    }

                    // ================================
                    // GROUPS
                    // ================================

                    match /groups/{groupId} {
                        /**
                         * Check if user is the group leader
                         */
                        function isGroupLeader() {
                            let group = get(/databases/$(database)/documents/year/$(year)/departments/$(department)/courses/$(course)/groups/$(groupId));
                            return group.data.members.leader == request.auth.uid;
                        }

                        /**
                         * Check if user is a group member (in members.members array)
                         */
                        function isGroupMember() {
                            let group = get(/databases/$(database)/documents/year/$(year)/departments/$(department)/courses/$(course)/groups/$(groupId));
                            return request.auth.uid == group.data.members.leader || 
                                   request.auth.uid in group.data.members.members;
                        }

                        /**
                         * Check if user is the group adviser
                         */
                        function isGroupAdviser() {
                            let group = get(/databases/$(database)/documents/year/$(year)/departments/$(department)/courses/$(course)/groups/$(groupId));
                            return group.data.members.adviser != null && 
                                   request.auth.uid == group.data.members.adviser;
                        }

                        /**
                         * Check if user is the group editor
                         */
                        function isGroupEditor() {
                            let group = get(/databases/$(database)/documents/year/$(year)/departments/$(department)/courses/$(course)/groups/$(groupId));
                            return group.data.members.editor != null && 
                                   request.auth.uid == group.data.members.editor;
                        }

                        /**
                         * Check if user is the group statistician
                         */
                        function isGroupStatistician() {
                            let group = get(/databases/$(database)/documents/year/$(year)/departments/$(department)/courses/$(course)/groups/$(groupId));
                            return group.data.members.statistician != null && 
                                   request.auth.uid == group.data.members.statistician;
                        }

                        /**
                         * Check if user is a group panel member
                         */
                        function isGroupPanel() {
                            let group = get(/databases/$(database)/documents/year/$(year)/departments/$(department)/courses/$(course)/groups/$(groupId));
                            return group.data.members.panels != null && 
                                   request.auth.uid in group.data.members.panels;
                        }

                        /**
                         * Check if user is assigned expert for this group
                         */
                        function isAssignedExpert() {
                            return isGroupAdviser() || isGroupEditor() || isGroupStatistician();
                        }

                        /**
                         * Check if user has access to the group
                         */
                        function hasGroupAccess() {
                            return isGroupMember() || isAssignedExpert() || isGroupPanel() || isModeratorOrAbove();
                        }

                        /**
                         * Check if user is a expert role (adviser, editor, statistician)
                         * and is updating to assign themselves to the group
                         */
                        function isExpertSelfAssigning() {
                            return isExpert() && (
                                // Adviser assigning themselves
                                (isAdviser() && request.resource.data.members.adviser == request.auth.uid) ||
                                // Editor assigning themselves
                                (isEditor() && request.resource.data.members.editor == request.auth.uid) ||
                                // Statistician assigning themselves
                                (isStatistician() && request.resource.data.members.statistician == request.auth.uid)
                            );
                        }

                        // Group documents - read by members, staff; write by adviser, admin, head, moderator
                        allow read: if isAuthenticated() && hasGroupAccess();
                        allow create: if isAdminOrDeveloper() || isHead() || isAdviser() || isStudent();
                        allow update: if isAdminOrDeveloper() || isHead() || isGroupAdviser() || isGroupLeader() || isModerator() || isExpertSelfAssigning();
                        allow delete: if isAdminOrDeveloper() || isHead();

                        // ================================
                        // JOIN SUBCOLLECTION (invites/requests)
                        // Path: join/invites - invite documents containing userIds array
                        // Path: join/requests - join request documents containing userIds array
                        // ================================

                        match /join/{docId} {
                            // Anyone authenticated can read join data to check their invites/requests
                            allow read: if isAuthenticated();
                            // Group leader and admins can manage invites
                            allow create: if isAdminOrDeveloper() || isHead() || isGroupLeader();
                            allow update: if isAdminOrDeveloper() || isHead() || isGroupLeader() || 
                                // Users can remove themselves from invite lists (decline invite)
                                (docId == 'invites' && request.auth.uid in resource.data.userIds) ||
                                // Users can remove themselves from request lists (cancel request)
                                (docId == 'requests' && request.auth.uid in resource.data.userIds) ||
                                // Users can add themselves to request lists (request to join)
                                (docId == 'requests' && request.auth.uid in request.resource.data.userIds);
                            allow delete: if isAdminOrDeveloper() || isHead() || isGroupLeader();
                        }

                        // ================================
                        // EXPERT REQUESTS (under group)
                        // ================================

                        match /expertRequests/{requestId} {
                            /**
                             * Check if the current user is the requested expert for this request
                             */
                            function isRequestedExpert() {
                                let req = get(/databases/$(database)/documents/year/$(year)/departments/$(department)/courses/$(course)/groups/$(groupId)/expertRequests/$(requestId));
                                return req.data.expertUid == request.auth.uid;
                            }

                            // Expert requests - group members and staff can read
                            allow read: if isAuthenticated() && hasGroupAccess();
                            // Members can create, adviser/admin can manage
                            allow create: if isGroupMember() || isGroupAdviser() || isAdminOrDeveloper();
                            // The requested expert can respond, adviser/admin/head can also manage
                            allow update: if isRequestedExpert() || isGroupAdviser() || isAdminOrDeveloper() || isHead();
                            allow delete: if isAdminOrDeveloper() || isHead();
                        }

                        // ================================
                        // PROPOSALS (under group)
                        // ================================

                        match /proposals/{proposalId} {
                            // Proposals - group members and staff can read
                            allow read: if isAuthenticated() && hasGroupAccess();
                            // Members can create proposals
                            allow create: if isGroupMember() || isGroupAdviser() || isAdminOrDeveloper();
                            // Members can update their own, adviser/staff can update any
                            allow update: if isGroupMember() || isGroupAdviser() || isStaff();
                            allow delete: if isAdminOrDeveloper() || isHead() || isGroupAdviser();
                        }

                        // ================================
                        // AUDITS (under group)
                        // ================================

                        match /audits/{auditId} {
                            // Audits - read by group members and staff
                            allow read: if isAuthenticated() && hasGroupAccess();
                            // System creates audits automatically
                            allow create: if isAuthenticated() && hasGroupAccess();
                            // Audits should not be modified or deleted (immutable)
                            allow update, delete: if false;
                        }

                        // ================================
                        // PANEL COMMENTS (under group)
                        // Path: panelComments/meta - metadata/release state document
                        // Path: panelComments/meta/entries/{entryId} - individual comment entries
                        // ================================

                        match /panelComments/{docId} {
                            // Panel comments - group members and panel can read
                            allow read: if isAuthenticated() && hasGroupAccess();
                            // Panel members and advisers can create/update
                            allow create: if isGroupPanel() || isGroupAdviser() || isAdminOrDeveloper();
                            allow update: if isGroupPanel() || isGroupAdviser() || isGroupMember() || isModeratorOrAbove();
                            allow delete: if isAdminOrDeveloper() || isHead();

                            // Entries subcollection under panelComments
                            match /entries/{entryId} {
                                allow read: if isAuthenticated() && hasGroupAccess();
                                allow create: if isGroupPanel() || isGroupAdviser() || isAdminOrDeveloper();
                                allow update: if isGroupPanel() || isGroupAdviser() || isGroupMember() || isModeratorOrAbove();
                                allow delete: if isAdminOrDeveloper() || isHead() || isGroupAdviser();
                            }
                        }

                        // ================================
                        // THESIS (under group)
                        // ================================

                        match /thesis/{thesisId} {
                            /**
                             * Check if user is thesis reviewer
                             */
                            function isThesisReviewer() {
                                let thesis = get(/databases/$(database)/documents/year/$(year)/departments/$(department)/courses/$(course)/groups/$(groupId)/thesis/$(thesisId));
                                let reviewers = thesis.data.reviewers;
                                return reviewers != null && request.auth.uid in reviewers.keys();
                            }

                            /**
                             * Check thesis access
                             */
                            function hasThesisAccess() {
                                return hasGroupAccess() || isThesisReviewer();
                            }

                            // Thesis documents
                            allow read: if isAuthenticated() && hasThesisAccess();
                            allow create: if isGroupMember() || isGroupAdviser() || isAdminOrDeveloper();
                            allow update: if isGroupMember() || isAssignedExpert() || isThesisReviewer() || isModeratorOrAbove();
                            allow delete: if isAdminOrDeveloper() || isHead();

                            // ================================
                            // STAGES (under thesis)
                            // ================================

                            match /stages/{stage} {
                                // Stages inherit thesis access
                                allow read: if isAuthenticated() && hasThesisAccess();
                                allow create: if isGroupMember() || isAssignedExpert() || isAdminOrDeveloper();
                                allow update: if isGroupMember() || isAssignedExpert() || isModeratorOrAbove();
                                allow delete: if isAdminOrDeveloper() || isHead();

                                // ================================
                                // CHAPTERS (under stage)
                                // ================================

                                match /chapters/{chapterId} {
                                    // Chapters inherit thesis access
                                    allow read: if isAuthenticated() && hasThesisAccess();
                                    allow create: if isGroupMember() || isAssignedExpert() || isAdminOrDeveloper();
                                    allow update: if isGroupMember() || isAssignedExpert() || isModeratorOrAbove();
                                    allow delete: if isAdminOrDeveloper() || isHead() || isGroupAdviser();

                                    // ================================
                                    // SUBMISSIONS (under chapter)
                                    // ================================

                                    match /submissions/{submissionId} {
                                        // Submissions - thesis members and reviewers can read
                                        allow read: if isAuthenticated() && hasThesisAccess();
                                        // Group members can create submissions
                                        allow create: if isGroupMember() || isAssignedExpert();
                                        // Members and reviewers can update
                                        allow update: if isGroupMember() || isAssignedExpert() || isThesisReviewer() || isModeratorOrAbove();
                                        allow delete: if isAdminOrDeveloper() || isHead() || isGroupAdviser();

                                        // ================================
                                        // CHATS (under submission)
                                        // ================================

                                        match /chats/{chatId} {
                                            // Chats - thesis members and reviewers can read
                                            allow read: if isAuthenticated() && hasThesisAccess();
                                            // Anyone with thesis access can create chat messages
                                            allow create: if isAuthenticated() && hasThesisAccess();
                                            // Only message author can update their own message
                                            allow update: if isOwner(resource.data.senderId);
                                            // Only admin can delete chat messages
                                            allow delete: if isAdminOrDeveloper();
                                        }
                                    }
                                }

                                // ================================
                                // TERMINAL REQUIREMENTS (under stage)
                                // ================================

                                match /terminal/{terminalId} {
                                    allow read: if isAuthenticated() && hasThesisAccess();
                                    allow create: if isGroupMember() || isAssignedExpert() || isAdminOrDeveloper();
                                    allow update: if isGroupMember() || isAssignedExpert() || isModeratorOrAbove();
                                    allow delete: if isAdminOrDeveloper() || isHead();
                                }
                            }
                        }
                    }
                }
            }
        }

        // ====================================
        // GLOBAL COLLECTIONS
        // ====================================

        // Calendars - global schedule events
        match /calendars/{eventId} {
            allow read: if isAuthenticated();
            allow create: if isStaff();
            allow update: if isStaff();
            allow delete: if isAdminOrDeveloper() || isHead();
        }

        // Notifications - user-specific notifications
        match /notifications/{notificationId} {
            allow read: if isAuthenticated() && (isOwner(resource.data.userId) || isAdminOrDeveloper());
            allow create: if isAuthenticated();
            allow update: if isOwner(resource.data.userId) || isAdminOrDeveloper();
            allow delete: if isOwner(resource.data.userId) || isAdminOrDeveloper();
        }

        // Background jobs - system operations
        match /backgroundJobs/{jobId} {
            allow read: if isAuthenticated() && (isOwner(resource.data.userId) || isAdminOrDeveloper());
            allow create: if isAuthenticated();
            allow update: if isAuthenticated() && (isOwner(resource.data.userId) || isAdminOrDeveloper());
            allow delete: if isAdminOrDeveloper();
        }

        // Forms - global form definitions
        match /forms/{formId} {
            allow read: if isAuthenticated();
            allow write: if isAdminOrDeveloper() || isHead();
        }

        // Form submissions
        match /formSubmissions/{submissionId} {
            allow read: if isAuthenticated() && (isOwner(resource.data.submittedBy) || isStaff());
            allow create: if isAuthenticated();
            allow update: if isOwner(resource.data.submittedBy) || isStaff();
            allow delete: if isAdminOrDeveloper();
        }

        // System settings
        match /settings/{settingId} {
            allow read: if isAuthenticated();
            allow write: if isAdminOrDeveloper();
        }

        // ====================================
        // CATCH-ALL DENY RULE
        // ====================================

        // Deny all other access by default
        match /{document=**} {
            allow read, write: if false;
        }
    }
}
